**1 检索方式**
**1.1 常见的方式**
（1）全文检索
（2）向量检索
（3）混合检索

**1.2 es中内置的检索方式**
1.2.1 ES 的核心特点
原生支持全文检索：这是 ES 的“老本行”，基于 Lucene，拥有业界顶尖的文本分析和关键词搜索能力。
支持向量检索：通过 dense_vector 数据类型，可以存储嵌入向量，并使用 knn_search 进行相似度检索。
强大的元数据管理：可以像传统数据库一样，为每个文档定义丰富的结构化字段（如 title, author, date），并进行高效的过滤和聚合。
分布式和可扩展性：天生为分布式设计，可以轻松处理海量数据和高并发查询，具备高可用性。
混合搜索：这是 ES 在 RAG 场景下最吸引人的地方。它可以在单次查询中，将关键词搜索（全文检索）的得分和向量搜索的得分进行融合，得到最终的排序结果。这比在应用层手动合并两个结果集要高效和科学得多。

1.2.2 全文检索步骤
第 1 步：建立倒排索引
第 2 步：执行查询与相关性评分。ES 会为每个匹配的文档计算一个 _score，并按照分数降序排列。现代 ES 默认使用的评分算法是 BM25，它是对经典 TF-IDF 算法的改进。

1.2.3 BM25
BM25 是 TF-IDF 的优化版本，被现代搜索引擎广泛采用。它针对 TF-IDF 的缺陷做了两个重要改进：
饱和 TF：BM25 为词频（TF）设置了一个上限。随着一个词在文档中出现的次数增加，TF 带来的得分增益会逐渐变缓并趋于饱和。这意味着，出现 20 次并不比出现 10 次重要一倍，这更符合实际情况。
文档长度归一化：BM25 将文档长度考虑在内。如果一个词在很短的文档中出现 2 次，其权重应该高于在长篇大论的文档中出现 2 次。

聚合策略：求和（Summation）
BM25对多词查询的评分公式本质上是：
Score(文档D, 查询Q) = Σ [ BM25_score(词t_i, 文档D) ] （对于查询Q中的每个词t_i）.每个文档会有一个针对所有命中词的总分。
这意味着：
文档D与查询Q的最终相关性得分，是D与Q中每个词的BM25得分的简单相加。
一个文档即使只与查询中的部分词语高度相关，但如果其他词语完全不匹配，它的总分也可能不如一个与所有词语都中等相关的文档。

**1.3 混合检索**
1.3.1 归一化
（1）最小-最大归一化
这是最直观和常用的方法。
公式：
norm_score = (raw_score - min_score) / (max_score - min_score)
步骤：
对BM25返回的前k个结果，找到其中的最小分数和最大分数
对向量检索返回的前k个结果，同样找到最小和最大余弦相似度
分别将两组分数线性映射到[0, 1]区间
示例：
BM25分数：[28, 15, 10, 8] → 归一化后：[1.0, 0.35, 0.1, 0.0]
向量分数：[0.95, 0.87, 0.82, 0.75] → 归一化后：[1.0, 0.6, 0.35, 0.0]
